<!DOCTYPE html>\n<html lang=\"en\">\n<head>\n    <meta charset=\"UTF-8\">\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n    <title>Site Visits - Mobile Dashboard</title>\n    <style>\n        body {\n            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;\n            margin: 0;\n            padding: 20px;\n            background-color: #f8f9fa;\n        }\n        .header {\n            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);\n            color: white;\n            padding: 20px;\n            border-radius: 10px;\n            margin-bottom: 20px;\n            text-align: center;\n        }\n        .stats-grid {\n            display: grid;\n            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));\n            gap: 15px;\n            margin-bottom: 20px;\n        }\n        .stat-card {\n            background: white;\n            padding: 20px;\n            border-radius: 10px;\n            box-shadow: 0 2px 10px rgba(0,0,0,0.1);\n            text-align: center;\n        }\n        .stat-number {\n            font-size: 24px;\n            font-weight: bold;\n            color: #667eea;\n        }\n        .stat-label {\n            font-size: 12px;\n            color: #666;\n            margin-top: 5px;\n        }\n        .visit-card {\n            background: white;\n            padding: 15px;\n            border-radius: 10px;\n            margin-bottom: 15px;\n            box-shadow: 0 2px 10px rgba(0,0,0,0.1);\n        }\n        .visit-header {\n            display: flex;\n            justify-content: space-between;\n            align-items: center;\n            margin-bottom: 10px;\n        }\n        .visit-title {\n            font-weight: bold;\n            font-size: 16px;\n        }\n        .status-badge {\n            padding: 4px 8px;\n            border-radius: 20px;\n            font-size: 12px;\n            font-weight: bold;\n        }\n        .status-planned { background: #fff3cd; color: #856404; }\n        .status-progress { background: #d4edda; color: #155724; }\n        .status-completed { background: #d1ecf1; color: #0c5460; }\n        .btn {\n            padding: 10px 20px;\n            border: none;\n            border-radius: 5px;\n            font-weight: bold;\n            cursor: pointer;\n            margin: 5px;\n        }\n        .btn-primary {\n            background: #667eea;\n            color: white;\n        }\n        .btn-success {\n            background: #28a745;\n            color: white;\n        }\n        .btn-block {\n            width: 100%;\n            display: block;\n        }\n        .quick-actions {\n            position: fixed;\n            bottom: 20px;\n            right: 20px;\n        }\n        .fab {\n            width: 60px;\n            height: 60px;\n            border-radius: 50%;\n            background: #667eea;\n            color: white;\n            border: none;\n            font-size: 24px;\n            box-shadow: 0 4px 20px rgba(0,0,0,0.3);\n            cursor: pointer;\n        }\n    </style>\n</head>\n<body>\n    <div class=\"header\">\n        <h1>üìç Site Visits</h1>\n        <p>Mobile Dashboard</p>\n    </div>\n\n    <div class=\"stats-grid\" id=\"statsGrid\">\n        <!-- Stats will be loaded here -->\n    </div>\n\n    <div id=\"visitsList\">\n        <!-- Visits will be loaded here -->\n    </div>\n\n    <div class=\"quick-actions\">\n        <button class=\"fab\" onclick=\"createNewVisit()\">+</button>\n    </div>\n\n    <script>\n        // Load dashboard data on page load\n        document.addEventListener('DOMContentLoaded', function() {\n            loadDashboardData();\n            loadTodayVisits();\n        });\n\n        function loadDashboardData() {\n            frappe.call({\n                method: 'crm.api.site_visit.get_visit_dashboard_data',\n                callback: function(r) {\n                    if (r.message) {\n                        displayStats(r.message);\n                    }\n                }\n            });\n        }\n\n        function displayStats(data) {\n            const statsGrid = document.getElementById('statsGrid');\n            statsGrid.innerHTML = `\n                <div class=\"stat-card\">\n                    <div class=\"stat-number\">${data.total_today}</div>\n                    <div class=\"stat-label\">Today's Visits</div>\n                </div>\n                <div class=\"stat-card\">\n                    <div class=\"stat-number\">${data.completed_today}</div>\n                    <div class=\"stat-label\">Completed</div>\n                </div>\n                <div class=\"stat-card\">\n                    <div class=\"stat-number\">${data.in_progress_today}</div>\n                    <div class=\"stat-label\">In Progress</div>\n                </div>\n                <div class=\"stat-card\">\n                    <div class=\"stat-number\">${data.pending_followups.length}</div>\n                    <div class=\"stat-label\">Pending Follow-ups</div>\n                </div>\n            `;\n        }\n\n        function loadTodayVisits() {\n            frappe.call({\n                method: 'crm.api.site_visit.get_upcoming_visits',\n                args: { limit: 20 },\n                callback: function(r) {\n                    if (r.message) {\n                        displayVisits(r.message);\n                    }\n                }\n            });\n        }\n\n        function displayVisits(visits) {\n            const visitsList = document.getElementById('visitsList');\n            if (visits.length === 0) {\n                visitsList.innerHTML = `\n                    <div class=\"visit-card\">\n                        <p style=\"text-align: center; color: #666;\">No upcoming visits</p>\n                    </div>\n                `;\n                return;\n            }\n\n            visitsList.innerHTML = visits.map(visit => `\n                <div class=\"visit-card\">\n                    <div class=\"visit-header\">\n                        <div class=\"visit-title\">${visit.reference_title}</div>\n                        <div class=\"status-badge status-${visit.status.toLowerCase().replace(' ', '')}\">\n                            ${visit.status}\n                        </div>\n                    </div>\n                    <div style=\"color: #666; font-size: 14px; margin-bottom: 10px;\">\n                        üìÖ ${visit.visit_date} ‚Ä¢ ${visit.visit_type}<br>\n                        üìç ${visit.city || 'Location not set'}\n                    </div>\n                    <div style=\"display: flex; gap: 10px;\">\n                        ${visit.status === 'Planned' ? \n                            `<button class=\"btn btn-primary\" onclick=\"checkIn('${visit.name}')\">üìç Check In</button>` : ''}\n                        ${visit.status === 'In Progress' ? \n                            `<button class=\"btn btn-success\" onclick=\"checkOut('${visit.name}')\">‚úÖ Check Out</button>` : ''}\n                        <button class=\"btn\" onclick=\"viewVisit('${visit.name}')\" style=\"background: #f8f9fa;\">View</button>\n                    </div>\n                </div>\n            `).join('');\n        }\n\n        function checkIn(visitId) {\n            if (!navigator.geolocation) {\n                alert('Geolocation is not supported by this browser.');\n                return;\n            }\n\n            navigator.geolocation.getCurrentPosition(\n                function(position) {\n                    frappe.call({\n                        method: 'crm.api.site_visit.quick_checkin',\n                        args: {\n                            visit_id: visitId,\n                            latitude: position.coords.latitude,\n                            longitude: position.coords.longitude,\n                            accuracy: Math.round(position.coords.accuracy)\n                        },\n                        callback: function(r) {\n                            if (r.message && r.message.success) {\n                                alert('Check-in successful!');\n                                loadTodayVisits();\n                                loadDashboardData();\n                            } else {\n                                alert('Check-in failed: ' + (r.message.message || 'Unknown error'));\n                            }\n                        }\n                    });\n                },\n                function(error) {\n                    alert('Error getting location: ' + error.message);\n                }\n            );\n        }\n\n        function checkOut(visitId) {\n            const summary = prompt('Enter a brief visit summary (optional):');\n            const quality = prompt('Lead quality (Hot/Warm/Cold):');\n\n            if (!navigator.geolocation) {\n                alert('Geolocation is not supported by this browser.');\n                return;\n            }\n\n            navigator.geolocation.getCurrentPosition(\n                function(position) {\n                    frappe.call({\n                        method: 'crm.api.site_visit.quick_checkout',\n                        args: {\n                            visit_id: visitId,\n                            latitude: position.coords.latitude,\n                            longitude: position.coords.longitude,\n                            visit_summary: summary,\n                            lead_quality: quality\n                        },\n                        callback: function(r) {\n                            if (r.message && r.message.success) {\n                                alert('Check-out successful! Duration: ' + r.message.duration);\n                                loadTodayVisits();\n                                loadDashboardData();\n                            } else {\n                                alert('Check-out failed: ' + (r.message.message || 'Unknown error'));\n                            }\n                        }\n                    });\n                },\n                function(error) {\n                    alert('Error getting location: ' + error.message);\n                }\n            );\n        }\n\n        function viewVisit(visitId) {\n            window.open('/app/crm-site-visit/' + visitId, '_blank');\n        }\n\n        function createNewVisit() {\n            window.open('/app/crm-site-visit/new', '_blank');\n        }\n    </script>\n</body>\n</html>